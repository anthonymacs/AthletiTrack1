<!-- templates/reports/dashboard.html -->
{% extends "base.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}Analytics Dashboard{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
    <h1 class="h2">{{ report_title|default:"Analytics Dashboard" }}</h1>
    <a href="{% url 'export-athletes-csv' %}" class="btn btn-outline-info btn-sm">
        <i class="fas fa-download me-2"></i>Export All Athlete Data
    </a>
</div>

<!--
    ROW 1: High-Level Overview Cards
-->
<div class="row">
    <!-- Athlete Overview -->
    <div class="col-md-6 col-xl-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Total Athletes</h6>
                        <h3 class="mb-0">{{ overview_stats.total_athletes }}</h3>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <small>Male: <span class="fw-bold">{{ overview_stats.total_male_athletes }}</span></small>
                    <small>Female: <span class="fw-bold">{{ overview_stats.total_female_athletes }}</span></small>
                </div>
            </div>
        </div>
    </div>
    <!-- Coach Overview -->
    <div class="col-md-6 col-xl-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Total Coaches</h6>
                        <h3 class="mb-0">{{ overview_stats.total_coaches }}</h3>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <small>Male: <span class="fw-bold">{{ overview_stats.total_male_coaches }}</span></small>
                    <small>Female: <span class="fw-bold">{{ overview_stats.total_female_coaches }}</span></small>
                </div>
            </div>
        </div>
    </div>
    <!-- University Winrate -->
    <div class="col-md-6 col-xl-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body text-center">
                <h6 class="text-muted mb-2">Overall Winrate</h6>
                <h3 class="mb-0 text-success">{{ kpis.winrate|default:"N/A" }}</h3>
                <small class="text-muted">{{ kpis.total_wins }} Wins / {{ kpis.total_losses }} Losses</small>
            </div>
        </div>
    </div>
</div>

<!--
    ROW 2: Detailed Distribution Tables and Leaderboards
-->
<div class="row">
    <!-- Athlete Distribution by Sport -->
    <div class="col-lg-5 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header"><h5 class="card-title mb-0">Athlete Distribution by Sport</h5></div>
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover mb-0">
                    <thead class="table-light"><tr><th>Sport</th><th class="text-center">Total</th><th class="text-center">Male</th><th class="text-center">Female</th></tr></thead>
                    <tbody>
                        {% for item in athletes_by_sport_gender %}
                        <tr>
                            <td><a href="{% url 'athlete-list' %}?sport={{ item.id }}" class="text-decoration-none fw-bold">{{ item.name }}</a></td>
                            <td class="text-center"><span class="badge bg-dark rounded-pill">{{ item.total_athletes }}</span></td>
                            <td class="text-center"><a href="{% url 'athlete-list' %}?sport={{ item.id }}&gender=MALE"><span class="badge bg-primary rounded-pill">{{ item.male_athletes }}</span></a></td>
                            <td class="text-center"><a href="{% url 'athlete-list' %}?sport={{ item.id }}&gender=FEMALE"><span class="badge bg-danger rounded-pill">{{ item.female_athletes }}</span></a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Counts by Campus -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header"><h4 class="card-title mb-0">Distribution by Campus</h4></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <h6>Athletes</h6>
                        <ul class="list-unstyled">
                            {% for campus in overview_stats.athletes_by_campus %}
                                <li>
                                    <a href="{% url 'athlete-list' %}?campus={{ campus.id }}" class="text-decoration-none">
                                        {{ campus.name }}: <span class="fw-bold">{{ campus.count }}</span>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-6">
                        <h6>Coaches</h6>
                        <ul class="list-unstyled">
                            {% for campus in overview_stats.coaches_by_campus %}
                                <li>
                                    <a href="{% url 'coach-list' %}?campus={{ campus.id }}" class="text-decoration-none">
                                        {{ campus.name }}: <span class="fw-bold">{{ campus.count }}</span>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header"><h4 class="card-title mb-0">Recent Game History</h4></div>
            <div class="list-group list-group-flush">
                {% for event in game_history %}
                    <a href="{% url 'event-detail' pk=event.pk %}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ event.name }}</h6>
                            <small>{{ event.end_time|date:"M d, Y" }}</small>
                        </div>
                        <p class="mb-1">
                            <!-- Show Win/Loss status with colored badges -->
                            {% if event.our_score > event.opponent_score %}
                                <span class="badge bg-success">WIN</span>
                            {% elif event.our_score < event.opponent_score %}
                                <span class="badge bg-danger">LOSS</span>
                            {% else %}
                                <span class="badge bg-secondary">TIE</span>
                            {% endif %}
                            <!-- Display the score -->
                            <span class="fw-bold">{{ event.our_score }} - {{ event.opponent_score }}</span>
                        </p>
                    </a>
                {% empty %}
                    <div class="list-group-item">No completed game reports found.</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<hr class="my-4">

<!-- REPORT TYPE 4 & 5: Dynamic Performance Charts -->
<div class="row">
    <!-- Team Performance Bar Chart -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header"><h4 class="card-title mb-0">Team Performance Comparison</h4></div>
            <div class="card-body d-flex flex-column">
                <p class="card-text text-muted small">Compare all athletes on a team for a specific metric.</p>
                <form id="barChartFilterForm">
                    <!-- Step 1: Select Team -->
                    <div class="mb-2">
                        <select id="barTeamSelect" class="form-select select2-filter" title="Select a Team">
                            <option value="" selected disabled>1. Select a Team</option>
                            {% for team in all_teams %}
                                <option value="{{ team.id }}">{{ team }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Step 2: Select Statistic (Initially disabled) -->
                    <div class="mb-3">
                        <select id="barStatSelect" class="form-select select2-filter" title="Select a Statistic" disabled>
                            <option value="" selected disabled>2. Select a Statistic</option>
                            <!-- Options will be added here by JavaScript -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" disabled>Generate Bar Chart</button>
                </form>
            <div class="mt-4 flex-grow-1"><canvas id="performanceBarChart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- Stat Distribution Pie Chart -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="card-title mb-0">Events Calendar</h5></div>
            <div class="card-body"><div id="calendar"></div></div>
        </div>
    </div>
</div>

<!--<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="card-title mb-0">Events Calendar</h5></div>
            <div class="card-body"><div id="calendar"></div></div>
        </div>
    </div>
</div>-->
{% endblock %}

{% block scripts %}
<!-- UNIFIED SCRIPT BLOCK -->
<script>
$(function() {
    // =============================================
    // === SELECT2 INITIALIZATION (Admin Filters) ===
    // =============================================
    $('.select2-filter').select2({
        theme: 'bootstrap-5',
        placeholder: 'Select an option'
    });

    // =============================================
    // === HANDLE "SELECT ALL" CHECKBOX ===
    // =============================================
    $('#selectAll').on('click', function() {
        $('input[name="athlete_ids"]').prop('checked', $(this).prop('checked'));
    });

    // =============================================
    // === FULLCALENDAR INITIALIZATION ===
    // =============================================
    const calendarEl = document.getElementById('calendar');
    if (calendarEl) {
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            events: '{% url "calendar-events" %}',
            themeSystem: 'bootstrap5',
            height: 'auto',
            navLinks: true,
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                if (info.event.url) window.location.href = info.event.url;
            }
        });
        calendar.render();
    }

    // =============================================
    // === DYNAMIC DROPDOWN LOGIC FOR BAR CHART ===
    // =============================================
    const barTeamSelect = $('#barTeamSelect');
    const barStatSelect = $('#barStatSelect');
    const barChartButton = $('#barChartFilterForm button[type="submit"]');

    barTeamSelect.on('change', function() {
        const teamId = $(this).val();
        if (!teamId) return;

        barStatSelect.html('<option selected disabled>Loading...</option>').prop('disabled', true);
        barChartButton.prop('disabled', true);
        const url = `{% url 'stats-for-team' %}?team_id=${teamId}`;
        
        fetch(url)
            .then(response => response.json())
            .then(stats => {
                let optionsHtml = '<option selected disabled>2. Select a Statistic</option>';
                stats.forEach(stat => {
                    optionsHtml += `<option value="${stat.name}">${stat.name}</option>`;
                });
                barStatSelect.html(optionsHtml).prop('disabled', false);
                barChartButton.prop('disabled', false);
            })
            .catch(error => console.error('Error fetching stats for team:', error));
    });

    // =============================================
    // === BAR CHART LOGIC ===
    // =============================================
    const barCtx = document.getElementById('performanceBarChart');
    let myBarChart = null;
    if (barCtx) {
        $('#barChartFilterForm').on('submit', function(e) {
            e.preventDefault();
            const teamId = barTeamSelect.val();
            const statName = barStatSelect.val();
            const url = `{% url 'get-performance-chart-data' %}?team_id=${teamId}&stat_name=${statName}&chart_type=comparison`;

            fetch(url)
                .then(response => response.json())
                .then(result => {
                    if (myBarChart) myBarChart.destroy();
                    myBarChart = new Chart(barCtx, {
                        type: 'bar',
                        data: {
                            labels: result.labels,
                            datasets: [{
                                data: result.data,
                                backgroundColor: 'rgba(0, 123, 255, 0.5)'
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { x: { beginAtZero: true } },
                            plugins: {
                                legend: { display: false },
                                title: { display: true, text: `${statName} Comparison` }
                            }
                        }
                    });
                })
                .catch(error => console.error('Bar Chart Error:', error));
        });
    }

    // =============================================
    // === LIVE SEARCH FUNCTIONALITY ===
    // =============================================
    const searchInput = $("#liveSearchInput");
    const resultsContainer = $("#searchResultsContainer");

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    const handleSearch = debounce(function() {
        const query = searchInput.val().trim();
        if (query.length > 0) {
            fetch(`{% url 'live-search' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    resultsContainer.empty();
                    if (data.results && data.results.length > 0) {
                        data.results.forEach(result => {
                            const imageUrl = result.image_url || "{% static 'images/default_profile.png' %}";
                            const resultItem = `
                                <a href="${result.url}" class="list-group-item list-group-item-action d-flex align-items-center">
                                    <img src="${imageUrl}" class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">
                                    <div>
                                        <div class="fw-bold">${result.name}</div>
                                        <small class="text-muted">${result.role}</small>
                                    </div>
                                </a>`;
                            resultsContainer.append(resultItem);
                        });
                    } else {
                        resultsContainer.html('<span class="list-group-item">No results found</span>');
                    }
                    resultsContainer.addClass('active');
                })
                .catch(err => {
                    console.error("Search error:", err);
                    resultsContainer.html('<span class="list-group-item text-danger">Error fetching results</span>');
                });
        } else {
            resultsContainer.removeClass('active').empty();
        }
    }, 300);

    searchInput.on("input", handleSearch);

    // Hide dropdown when clicking outside
    $(document).on('click', function(e) {
        if (!searchInput.is(e.target) && !resultsContainer.is(e.target) && resultsContainer.has(e.target).length === 0) {
            resultsContainer.removeClass('active').empty();
        }
    });
});
</script>
{% endblock %}