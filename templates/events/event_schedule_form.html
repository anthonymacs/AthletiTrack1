<!-- templates/events/event_schedule_form.html -->
{% extends "base.html" %}
{% block content %}
{% if show_formset %}
    <!-- STEP 2: The Formset -->
    <h2>Schedule Events for <span class="text-primary">{{ selected_team.name }}</span></h2>
    <p>All created events will automatically include all athletes from this team and assign the team's coach as the one in charge.</p>
    <form method="post" action="?team={{ selected_team.id }}">
        {% csrf_token %}
        {{ formset.management_form }}

        <div id="formset-container">
            {% for form in formset %}
            <div class="card mb-3 form-row">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">{{ form.name.label_tag }}{{ form.name }}</div>
                        <div class="col-md-6">{{ form.location.label_tag }}{{ form.location }}</div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">{{ form.start_time.label_tag }}{{ form.start_time }}</div>
                        <div class="col-md-6">{{ form.end_time.label_tag }}{{ form.end_time }}</div>
                    </div>
                    <div class="mt-2">{{ form.description.label_tag }}{{ form.description }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Template for cloning -->
        <div id="empty-form-template" style="display: none;">
            <div class="card mb-3 form-row">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">{{ formset.empty_form.name.label_tag }}{{ formset.empty_form.name }}</div>
                        <div class="col-md-6">{{ formset.empty_form.location.label_tag }}{{ formset.empty_form.location }}</div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">{{ formset.empty_form.start_time.label_tag }}{{ formset.empty_form.start_time }}</div>
                        <div class="col-md-6">{{ formset.empty_form.end_time.label_tag }}{{ formset.empty_form.end_time }}</div>
                    </div>
                    <div class="mt-2">{{ formset.empty_form.description.label_tag }}{{ formset.empty_form.description }}</div>
                </div>
            </div>
        </div>

        <button type="button" id="add-form-button" class="btn btn-success">+ Add Another Event</button>
        <hr>
        <button type="submit" class="btn btn-primary">Save All Events</button>
        <a href="{% url 'event-list' %}" class="btn btn-secondary">Cancel</a>
    </form>
{% else %}
    <!-- STEP 1: The Filter -->
    <h2>Step 1: Select a Group to Schedule For</h2>
    <div class="card card-body">
        <form method="get">
            {{ filter_form.as_p }}
            <button type="submit" class="btn btn-primary mt-3">Next: Schedule Events</button>
        </form>
    </div>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addFormButton = document.getElementById('add-form-button');
    const formsetContainer = document.getElementById('formset-container');
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
    const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');

    addFormButton.addEventListener('click', function() {
        // Get the current number of forms
        let currentFormCount = parseInt(totalFormsInput.value);

        // Create a new row from the template
        let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, currentFormCount);

        // Append the new row to the container
        formsetContainer.insertAdjacentHTML('beforeend', newFormHtml);

        // Increment the total forms count in the management form
        totalFormsInput.value = currentFormCount + 1;
    });
});
</script>
{% endblock %}