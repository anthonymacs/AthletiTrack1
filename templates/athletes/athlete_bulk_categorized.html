<!-- templates/athletes/athlete_bulk_categorized.html -->
{% extends "base.html" %}
{% block title %}{{ form_title }}{% endblock %}
{% block content %}
<h2>{{ form_title }}</h2>
<p>For each category, add new athletes. Use the "+ Add Row" button inside a category to add more fields for that specific group.</p>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="accordion" id="categoryAccordion">
        {% for sport, campus, formset in categorized_formsets %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading-{{ formset.prefix }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ formset.prefix }}">
                    {{ sport.name }} - {{ campus.name }}
                </button>
            </h2>
            <div id="collapse-{{ formset.prefix }}" class="accordion-collapse collapse" data-bs-parent="#categoryAccordion">
                <div class="accordion-body">
                    {{ formset.management_form }}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Email</th>
                                <th>Gender</th>
                                <th>Image</th>
                            </tr>
                        </thead>
                        <tbody id="formset-container-{{ formset.prefix }}">
                            {% for form in formset %}
                            <tr class="form-row-{{ formset.prefix }}">
                                <td>{{ form.first_name }}</td>
                                <td>{{ form.last_name }}</td>
                                <td>{{ form.email }}</td>
                                <td>{{ form.gender }}</td> <!-- ADD THIS FIELD -->
                                <td>{{ form.image }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- Button is specific to this formset -->
                    <button type="button" class="btn btn-sm btn-success add-form-button" data-prefix="{{ formset.prefix }}">+ Add Row</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <hr>
    <button type="submit" class="btn btn-primary">Save All Athletes</button>
    <a href="{% url 'athlete-list' %}" class="btn btn-secondary">Cancel</a>
</form>

<!-- This template table is now outside the form but still on the page -->
<table style="display: none;">
    <tbody id="empty-form-template">
        <tr>
            <td>{{ categorized_formsets.0.2.empty_form.first_name }}</td>
            <td>{{ categorized_formsets.0.2.empty_form.last_name }}</td>
            <td>{{ categorized_formsets.0.2.empty_form.email }}</td>
            <td>{{ categorized_formsets.0.2.empty_form.gender }}</td> <!-- ADD THE GENDER FIELD HERE -->
            <td>{{ categorized_formsets.0.2.empty_form.image }}</td>
        </tr>
    </tbody>
</table>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const emptyFormHtml = document.getElementById('empty-form-template').innerHTML;

    document.querySelectorAll('.add-form-button').forEach(button => {
        button.addEventListener('click', function() {
            const prefix = this.dataset.prefix;
            const formsetContainer = document.getElementById(`formset-container-${prefix}`);
            const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
            let currentFormCount = parseInt(totalFormsInput.value);

            // Replace the generic prefix with the specific one for this formset
            let newForm = emptyFormHtml.replace(/__prefix__/g, currentFormCount);
            // We need to replace the form name prefix as well
            newForm = newForm.replace(/form-/g, `${prefix}-`);

            formsetContainer.insertAdjacentHTML('beforeend', newForm);
            totalFormsInput.value = currentFormCount + 1;
        });
    });
});
</script>
{% endblock %}