<!-- templates/athletes/athlete_bulk_by_team.html -->
{% extends "base.html" %}

{% block title %}Bulk Add Athletes{% endblock %}

{% block content %}

{% if show_formset %}
    <!-- ============================================= -->
    <!-- === STEP 2: SHOW THE EXPANDABLE FORMSET === -->
    <!-- ============================================= -->
    <h2>Step 2: Add Athletes to <span class="text-primary">{{ selected_team }}</span></h2>
    <p>Fill out the rows for each new athlete. Use the button at the bottom to add more rows.</p>

    <form method="post" enctype="multipart/form-data" action="?team={{ selected_team.id }}">
        {% csrf_token %}
        {{ formset.management_form }}
        <table class="table">
            <thead><tr><th>First Name</th><th>Last Name</th><th>Email</th><th>Birthday</th><th>Image</th></tr></thead>
            <tbody id="formset-container">
                {% for form in formset %}<tr class="form-row">
                    <td>{{ form.first_name }}</td><td>{{ form.last_name }}</td><td>{{ form.email }}</td><td>{{ form.birthday }}</td><td>{{ form.image }}</td>
                </tr>{% endfor %}
            </tbody>
        </table>
        <table style="display: none;"><tbody id="empty-form-template"><tr class="form-row">
            <td>{{ formset.empty_form.first_name }}</td><td>{{ formset.empty_form.last_name }}</td><td>{{ formset.empty_form.email }}</td><td>{{ formset.empty_form.birthday }}</td><td>{{ formset.empty_form.image }}</td>
        </tr></tbody></table>
        <button type="button" id="add-form-button" class="btn btn-success">+ Add Another Row</button>
        <hr>
        <button type="submit" class="btn btn-primary">Save Athletes</button>
        <a href="{% url 'athlete-list' %}" class="btn btn-secondary">Cancel</a>
    </form>


{% else %}
    <h2>Step 1: Select a Team to Add Athletes To</h2>
    <p>Choose the team that these new athletes will be assigned to.</p>
    <div class="card card-body" style="max-width: 500px; margin: auto;">
        <form method="get">
            <!-- This manual rendering ensures the 'select2-filter' class is applied -->
            <div class="mb-3">
                <label for="{{ filter_form.team.id_for_label }}" class="form-label">{{ filter_form.team.label }}</label>
                {{ filter_form.team }}
            </div>
            <button type="submit" class="btn btn-primary mt-3 w-100">Next: Add Athletes</button>
        </form>
    </div>
{% endif %}
{% endblock %}


<!--
    ============================================================
    === THIS SCRIPT BLOCK IS THE KEY TO THE SOLUTION ===
    ============================================================
-->
{% block scripts %}
<script>
    // This code block is injected into base.html AFTER jQuery and Select2 are loaded.
    $(document).ready(function() {
        // This will find the "Team" dropdown and make it searchable.
        $('.select2-filter').select2({
            theme: 'bootstrap-5',
            placeholder: 'Type to search for a team...'
        });

        // This is the script for the expandable form on Step 2.
        const addFormButton = document.getElementById('add-form-button');
        if (addFormButton) {
            const formsetContainer = document.getElementById('formset-container');
            const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
            const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');

            addFormButton.addEventListener('click', function() {
                let currentFormCount = parseInt(totalFormsInput.value);
                let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, currentFormCount);
                formsetContainer.insertAdjacentHTML('beforeend', newFormHtml);
                totalFormsInput.value = currentFormCount + 1;
            });
        }
    });
</script>
{% endblock %}